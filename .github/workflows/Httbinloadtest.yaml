name: JMeter Load Test Pipeline

on:
  workflow_dispatch:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  loadtest:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Java (Temurin 17)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Install JMeter 5.6.3
        run: |
          sudo apt update
          sudo apt install -y wget tar
          wget https://archive.apache.org/dist/jmeter/binaries/apache-jmeter-5.6.3.tgz
          tar -xzf apache-jmeter-5.6.3.tgz
          echo "export PATH=$PATH:$(pwd)/apache-jmeter-5.6.3/bin" >> $GITHUB_ENV

      - name: Clone httpbin Repository
        run: git clone https://github.com/postmanlabs/httpbin.git

      - name: Build httpbin Docker Image
        run: docker build -t httpbin-app ./httpbin

      - name: Run httpbin Container
        run: |
          docker run -d -p 8080:80 --name httpbin-container httpbin-app
          sleep 10

      # ✅ Ensure result directories exist
      - name: Prepare Output Directories
        run: |
          mkdir -p jtl_files
          mkdir -p HTML_Reports

      # ✅ Execute JMeter Test with dynamic timestamp and correct naming
      - name: Execute JMeter Load Test
        run: |
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          REPORT_DIR="HTML_Reports/httpbin_loadtest_$TIMESTAMP"
          mkdir -p "$REPORT_DIR"

          apache-jmeter-5.6.3/bin/jmeter \
            -n \
            -t Jmeter_scripts/httpbin_loadtest.jmx \
            -l "jtl_files/httpbin_loadtest_${TIMESTAMP}.jtl" \
            -e \
            -o "$REPORT_DIR"

      - name: Commit and Push Results
        run: |
          git config --global user.email "k.pradeepreddy0604@gmail.com"
          git config --global user.name "pradeepreddy0604"
          git add jtl_files HTML_Reports
          git commit -m "Automated JMeter Results - $(date)" || echo "No new files to commit"
          git push
