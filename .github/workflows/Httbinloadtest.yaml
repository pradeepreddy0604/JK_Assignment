name: JMeter Load Test Pipeline

on:
  workflow_dispatch:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  loadtest:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Java (Temurin 17)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Install JMeter 5.6.3
        run: |
          sudo apt update
          sudo apt install -y wget tar curl
          wget https://archive.apache.org/dist/jmeter/binaries/apache-jmeter-5.6.3.tgz
          tar -xzf apache-jmeter-5.6.3.tgz
          echo "export PATH=$PATH:$(pwd)/apache-jmeter-5.6.3/bin" >> $GITHUB_ENV

      - name: Setup Log Folder and Patch Logging
        run: |
          mkdir -p logs/jmeter_logs
          sed -i 's|<Root level="INFO">|<Root level="DEBUG">|' apache-jmeter-5.6.3/bin/log4j2.xml
          sed -i 's|<FileName>.*</FileName>|<FileName>logs/jmeter_logs/jmeter.log</FileName>|' apache-jmeter-5.6.3/bin/log4j2.xml
          sed -i 's|<FilePattern>.*</FilePattern>|<FilePattern>logs/jmeter_logs/jmeter-%d{MM-dd-yyyy}-%i.log.gz</FilePattern>|' apache-jmeter-5.6.3/bin/log4j2.xml

      - name: Remove Old Container
        run: docker rm -f httpbin-container || true

      - name: Build httpbin Docker Image (Local Version)
        run: docker build -t httpbin-app ./httpbin

      - name: Run httpbin Container
        run: |
          docker run -d -p 8080:80 --name httpbin-container httpbin-app
          echo "Waiting 8 seconds..."
          sleep 8
          docker ps -a
          docker logs httpbin-container --tail 50 || true

      - name: Create Output Directories (Root Level)
        run: |
          mkdir -p jtl_files
          mkdir -p HTML_Reports
          mkdir -p logs/ping_results

      - name: Verify API Endpoint Reachability
        run: |
          for endpoint in "" get post put patch delete; do
            echo "Checking /$endpoint" >> logs/ping_results/ping_log.txt
            curl -I http://localhost:8080/$endpoint >> logs/ping_results/ping_log.txt 2>&1 || echo "FAILED /$endpoint" >> logs/ping_results/ping_log.txt
            echo "-------------------------------------" >> logs/ping_results/ping_log.txt
          done

      - name: Run JMeter Load Test
        run: |
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          SCRIPT_NAME="httpbin_loadtest"
          JTL="jtl_files/${SCRIPT_NAME}_${TIMESTAMP}.jtl"
          REPORT="HTML_Reports/${SCRIPT_NAME}_${TIMESTAMP}"
          apache-jmeter-5.6.3/bin/jmeter -n \
            -t Jmeter_scripts/${SCRIPT_NAME}.jmx \
            -l "$JTL" \
            -e -o "$REPORT" \
            -Jjmeter.exit.on.error=true

      - name: Rename JMeter Log
        run: |
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          mv logs/jmeter_logs/jmeter.log logs/jmeter_logs/httpbin_loadtest_${TIMESTAMP}.log || true

      - name: Commit Results to Repository
        run: |
          git config --global user.email "k.pradeepreddy0604@gmail.com"
          git config --global user.name "pradeepreddy0604"
          git add jtl_files HTML_Reports logs
          git commit -m "Automated Load Test Results - $(date)" || echo "No new updates to commit"
          git push

  deploy:
    needs: loadtest
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Deploy HTML Reports to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: ./HTML_Reports
          force_orphan: true
