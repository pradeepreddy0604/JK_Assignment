name: JMeter Load Test Pipeline

on:
  workflow_dispatch:
#  push:
#    branches:
#      - main

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  loadtest:
    runs-on: ubuntu-latest

    steps:
      # Checkout repo
      - name: Checkout Repository
        uses: actions/checkout@v4

      # Setup Java
      - name: Set up Java (Temurin 17)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      # Install JMeter
      - name: Install JMeter 5.6.3
        run: |
          sudo apt update
          sudo apt install -y wget tar curl
          wget https://archive.apache.org/dist/jmeter/binaries/apache-jmeter-5.6.3.tgz
          tar -xzf apache-jmeter-5.6.3.tgz
          echo "export PATH=$PATH:$(pwd)/apache-jmeter-5.6.3/bin" >> $GITHUB_ENV

      # Configure Logging
      - name: Patch Logging Configuration
        run: |
          mkdir -p logs/jmeter_logs
          sed -i 's|<Root level="INFO">|<Root level="DEBUG">|' apache-jmeter-5.6.3/bin/log4j2.xml
          sed -i 's|<FileName>.*</FileName>|<FileName>logs/jmeter_logs/jmeter.log</FileName>|' apache-jmeter-5.6.3/bin/log4j2.xml

      # Clean old container
      - name: Remove Old Container
        run: docker rm -f httpbin-container || true

      # Build and Run local httpbin Docker image
      - name: Build httpbin Docker Image
        run: docker build -t httpbin-app ./httpbin

      - name: Run httpbin Container
        run: |
          docker run -d -p 8080:80 --name httpbin-container httpbin-app
          echo "Waiting for container to start..."
          sleep 8
          docker ps -a
          docker logs httpbin-container --tail 30 || true

      # Prepare output directories
      - name: Prepare Output Directories
        run: |
          mkdir -p jtl_files
          mkdir -p HTML_Reports
          mkdir -p logs/ping_results

      # Verify endpoints before test
      - name: Verify API Endpoints
        run: |
          PING_LOG="logs/ping_results/ping_log_$(date +%Y%m%d_%H%M%S).txt"
          {
            echo "---- HTTPBIN Endpoint Check ----"
            for endpoint in get post put patch delete; do
              echo "Checking /$endpoint"
              curl -I http://localhost:8080/$endpoint
              echo "--------------------------------"
            done
          } >> "$PING_LOG"

      # Run JMeter Test
      - name: Run JMeter Load Test
        run: |
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          SCRIPT_NAME="httpbin_loadtest"
          JTL="jtl_files/${SCRIPT_NAME}_${TIMESTAMP}.jtl"
          REPORT="HTML_Reports/${SCRIPT_NAME}_${TIMESTAMP}"
          apache-jmeter-5.6.3/bin/jmeter -n \
            -t Jmeter_scripts/${SCRIPT_NAME}.jmx \
            -l "$JTL" \
            -e -o "$REPORT" \
            -Jjmeter.exit.on.error=true

      # Copy latest report to publish folder
      - name: Prepare Latest Report for GitHub Pages
        run: |
          mkdir -p LATEST_REPORT
          LATEST_FOLDER=$(ls -td HTML_Reports/* | head -1)
          echo "Publishing Folder: $LATEST_FOLDER"
          rm -rf LATEST_REPORT/*
          cp -r "$LATEST_FOLDER"/* LATEST_REPORT/

      # Upload report as artifact (for deploy job)
      - name: Upload Report Artifact
        uses: actions/upload-artifact@v4
        with:
          name: latest-report
          path: LATEST_REPORT/

      # Rename and store JMeter log
      - name: Rename JMeter Log
        run: |
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          mv logs/jmeter_logs/jmeter.log logs/jmeter_logs/httpbin_loadtest_${TIMESTAMP}.log || true

      # Commit results back to repo safely
      - name: Commit Results (Safe Push)
        run: |
          git config --global user.email "k.pradeepreddy0604@gmail.com"
          git config --global user.name "pradeepreddy0604"
          git add jtl_files HTML_Reports logs
          git commit -m "Automated Load Test Results - $(date)" || echo "No new changes"
          git pull --rebase origin main || true
          git push origin main || true

  # Deploy to GitHub Pages (latest report only)
  deploy:
    needs: loadtest
    runs-on: ubuntu-latest

    steps:
      - name: Download latest report artifact
        uses: actions/download-artifact@v4
        with:
          name: latest-report
          path: LATEST_REPORT/

      - name: Deploy Latest HTML Report to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: ./LATEST_REPORT
          force_orphan: true
